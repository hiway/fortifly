---

- name: install python 2.7
  raw: /usr/bin/apt install -y python-minimal

- name: run inventory
  setup:

- name: create user if missing
  user: name={{ssh_user}} password=* createhome=yes system=yes state=present

- name: enable key-based ssh access for user
  authorized_key: user={{ ssh_user }}
                  key="{{ item }}"
  with_file:
    - "{{ssh_public_key}}"

- name: Make sure we have a 'wheel' group
  group:
    name: wheel
    state: present

- name: Allow 'wheel' group to have passwordless sudo
  lineinfile:
    dest: /etc/sudoers
    state: present
    regexp: '^%wheel'
    line: '%wheel ALL=(ALL) NOPASSWD: ALL'
    validate: 'visudo -cf %s'

- name: Add sudoers users to wheel group
  user: name={{ ssh_user }} groups=wheel append=yes state=present createhome=yes

- name: install mosh
  apt: name=mosh state=present

- name: disable sshd root login
  lineinfile:
    destfile: /etc/ssh/sshd_config
    regexp: '^PermitRootLogin'
    line: 'PermitRootLogin no'
    state: present
    insertafter: '^#PermitRootLogin'
    validate: '/usr/sbin/sshd -T -f %s'
  notify:
  - restart sshd

- name: use specified port
  lineinfile:
    destfile: /etc/ssh/sshd_config
    regexp: '^Port'
    line: 'Port {{ssh_port}}'
    state: present
    insertafter: '^#Port'
    validate: '/usr/sbin/sshd -T -f %s'
  notify:
  - restart sshd

- name: run inventory
  setup:
